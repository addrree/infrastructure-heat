pipeline {
  agent { label 'tool' }

  parameters {
    string(name: 'BUILD_JOB', defaultValue: 'Andreyjob2', description: 'Имя job, который собирает jar')
    string(name: 'STACK_NAME', defaultValue: 'andrey-heat-stack', description: 'Heat stack name')
  }

  stages {
    stage('Get artifact from Build job') {
      steps {
        // Забираем target/*.jar из последней успешной сборки Л2
        copyArtifacts(
          projectName: params.BUILD_JOB,
          selector: lastSuccessful(),
          filter: 'target/*.jar',
          fingerprintArtifacts: true
        )
        sh 'ls -la target/*.jar'
      }
    }

    stage('Get VM IP from Heat') {
    steps {
        script {
        def vmIp = sh(
            script: 'openstack stack output show andrey-heat-stack server_ip -f value | tail -n 1',
            returnStdout: true
        ).trim()

        if (!vmIp) {
            error("VM_IP is empty. Heat stack has no server_ip output.")
        }

        env.VM_IP = vmIp
        echo "VM_IP=${env.VM_IP}"
        }
      }
    }

    stage('Deploy + restart') {
    steps {
        sh '''#!/usr/bin/env bash
        set -euo pipefail
        echo "Deploy to ${VM_IP}"

        # пример: кидаем jar на VM
        scp -o StrictHostKeyChecking=no target/my-java-app-1.0.0.jar ubuntu@${VM_IP}:/home/ubuntu/app.jar

        # пример: рестарт (если у тебя systemd сервис)
        ssh -o StrictHostKeyChecking=no ubuntu@${VM_IP} 'sudo systemctl restart myapp || true'
        '''
        }
      }
    }
  }
}
