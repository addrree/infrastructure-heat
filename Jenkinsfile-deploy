pipeline {
  agent { label 'tool' }

  options {
    timestamps()
    timeout(time: 15, unit: 'MINUTES')
  }

  parameters {
    string(name: 'VM_IP', defaultValue: '192.168.199.173', description: 'Target VM IP')
    string(name: 'BUILD_JOB', defaultValue: 'AndreyLAb2', description: 'Job that builds & archives artifact-restoringvalues.tgz')
    string(name: 'SSH_CRED_ID', defaultValue: 'ubuntu-agent-ssh, description: 'Jenkins SSH credential id for ubuntu@VM')
    booleanParam(name: 'ENABLE_DASH', defaultValue: true, description: 'Run Dash UI on port 8051')
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Get artifact from Build job') {
      steps {
        // забираем последний успешный артефакт
        copyArtifacts(
          projectName: params.BUILD_JOB,
          selector: lastSuccessful(),
          filter: 'artifact-restoringvalues.tgz',
          fingerprintArtifacts: true
        )
        sh '''#!/usr/bin/env bash
          set -e
          ls -la artifact-restoringvalues.tgz
        '''
      }
    }

    stage('Deploy to VM (systemd)') {
      steps {
        sshagent(credentials: [params.SSH_CRED_ID]) {
          sh '''#!/usr/bin/env bash
            set -euo pipefail

            VM_IP="${VM_IP}"
            ART="artifact-restoringvalues.tgz"
            REMOTE_DIR="/opt/restoringvalues"
            TMP_DIR="/tmp/restoringvalues_deploy"

            echo "==> Copy artifact to ${VM_IP}"
            ssh -o StrictHostKeyChecking=no ubuntu@"$VM_IP" "sudo mkdir -p ${REMOTE_DIR} ${TMP_DIR} && sudo chown -R ubuntu:ubuntu ${REMOTE_DIR} ${TMP_DIR}"

            scp -o StrictHostKeyChecking=no "$ART" ubuntu@"$VM_IP":"$TMP_DIR/$ART"

            echo "==> Remote deploy"
            ssh -o StrictHostKeyChecking=no ubuntu@"$VM_IP" "bash -s" <<'REMOTE'
              set -euo pipefail

              REMOTE_DIR="/opt/restoringvalues"
              TMP_DIR="/tmp/restoringvalues_deploy"
              ART="artifact-restoringvalues.tgz"

              echo "==> Install system deps"
              sudo apt-get update -y
              sudo apt-get install -y python3-venv python3-pip net-tools lsof

              echo "==> Stop old services if exist"
              sudo systemctl stop restoring-simulator.service 2>/dev/null || true
              sudo systemctl stop restoring-reciever.service 2>/dev/null || true
              sudo systemctl stop restoring-business.service 2>/dev/null || true
              sudo systemctl stop restoring-dash.service 2>/dev/null || true

              echo "==> Kill listeners (8092-8095, 8051) just in case"
              for p in 8092 8093 8094 8095 8051; do
                sudo fuser -k ${p}/tcp 2>/dev/null || true
              done

              echo "==> Unpack artifact"
              mkdir -p "$REMOTE_DIR"
              rm -rf "$REMOTE_DIR/Simulator" "$REMOTE_DIR/Reciever" "$REMOTE_DIR/Business" "$REMOTE_DIR/GUI" "$REMOTE_DIR/.venv" || true
              tar -xzf "$TMP_DIR/$ART" -C "$REMOTE_DIR"

              echo "==> Create venv & install requirements"
              cd "$REMOTE_DIR"
              python3 -m venv .venv
              . .venv/bin/activate
              pip install -U pip wheel
              pip install -r requirements.txt

              echo "==> Create systemd units"

              # Simulator
              sudo tee /etc/systemd/system/restoring-simulator.service >/dev/null <<'EOF'
[Unit]
Description=RestoringValues Simulator
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/restoringvalues
Environment=WEBSOCKET_HOST=127.0.0.1
ExecStart=/opt/restoringvalues/.venv/bin/python3 /opt/restoringvalues/Simulator/simulator.py
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

              # Reciever
              sudo tee /etc/systemd/system/restoring-reciever.service >/dev/null <<'EOF'
[Unit]
Description=RestoringValues Reciever
After=network.target restoring-simulator.service

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/restoringvalues
Environment=WEBSOCKET_HOST=127.0.0.1
ExecStart=/opt/restoringvalues/.venv/bin/python3 /opt/restoringvalues/Reciever/reciever.py
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

              # Business
              sudo tee /etc/systemd/system/restoring-business.service >/dev/null <<'EOF'
[Unit]
Description=RestoringValues Business
After=network.target restoring-reciever.service

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/restoringvalues
Environment=WEBSOCKET_HOST=127.0.0.1
ExecStart=/opt/restoringvalues/.venv/bin/python3 /opt/restoringvalues/Business/business.py
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

              # Dash (optional)
              sudo tee /etc/systemd/system/restoring-dash.service >/dev/null <<'EOF'
[Unit]
Description=RestoringValues Dash UI
After=network.target restoring-business.service

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/restoringvalues
Environment=WEBSOCKET_HOST=127.0.0.1
ExecStart=/opt/restoringvalues/.venv/bin/python3 /opt/restoringvalues/GUI/dash_app_prod.py
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

              echo "==> Reload systemd"
              sudo systemctl daemon-reload

              echo "==> Enable + start services"
              sudo systemctl enable restoring-simulator.service restoring-reciever.service restoring-business.service >/dev/null

              sudo systemctl restart restoring-simulator.service
              sudo systemctl restart restoring-reciever.service
              sudo systemctl restart restoring-business.service

              if [ "${ENABLE_DASH:-true}" = "true" ]; then
                sudo systemctl enable restoring-dash.service >/dev/null || true
                sudo systemctl restart restoring-dash.service || true
              else
                sudo systemctl stop restoring-dash.service 2>/dev/null || true
              fi

              echo "==> Quick health checks"
              sleep 5
              sudo systemctl --no-pager --full status restoring-simulator.service | head -n 30 || true
              sudo systemctl --no-pager --full status restoring-reciever.service | head -n 30 || true
              sudo systemctl --no-pager --full status restoring-business.service | head -n 30 || true
              if [ "${ENABLE_DASH:-true}" = "true" ]; then
                sudo systemctl --no-pager --full status restoring-dash.service | head -n 30 || true
              fi

              echo "==> Check listening ports"
              sudo ss -lntp | egrep ':8092|:8093|:8094|:8095|:8051' || true

              echo "==> Wait a bit and check Reciever output"
              sleep 10
              ls -la /opt/restoringvalues/Reciever/*.csv 2>/dev/null || true

              echo "DEPLOY OK"
REMOTE
          '''
        }
      }
    }
  }

  post {
    always {
      echo "Done."
      cleanWs()
    }
  }
}
