pipeline {
  agent { label 'tool' }

  options {
    timestamps()
    timeout(time: 15, unit: 'MINUTES')
    disableConcurrentBuilds()
  }

  parameters {
    string(name: 'TARGET_HOST', defaultValue: '192.168.199.93', description: 'Deploy host')
    string(name: 'BUILD_JOB', defaultValue: 'AndreyIL/AndreyLAb2', description: 'L2 job name that produces dist/*.whl')
    string(name: 'SSH_CRED_ID', defaultValue: 'Andrey-heatvm', description: 'Andrey-heatvm')
  }

  stages {

    stage('Fetch artifact from L2') {
      steps {
        script {
          sh 'rm -rf deploy_art && mkdir -p deploy_art'

          // CopyArtifact plugin у тебя есть (видно по логу), поэтому используем его
          step([
            $class: 'CopyArtifact',
            projectName: params.BUILD_JOB,
            selector: [$class: 'StatusBuildSelector', stable: false],
            filter: 'dist/*.whl',
            target: 'deploy_art',
            fingerprintArtifacts: true
          ])

          sh 'find deploy_art -maxdepth 3 -type f -print'
        }
      }
    }

    stage('Upload + install + restart') {
      steps {
        withCredentials([sshUserPrivateKey(
          credentialsId: params.SSH_CRED_ID,
          keyFileVariable: 'SSH_KEY_FILE',
          usernameVariable: 'SSH_USER'
        )]) {
          sh '''#!/usr/bin/env bash
            set -euo pipefail

            chmod 600 "$SSH_KEY_FILE"

            # wheel может лежать как deploy_art/dist/*.whl или deploy_art/*.whl — обработаем оба варианта
            WHEEL="$(ls -1 deploy_art/**/*.whl deploy_art/*.whl 2>/dev/null | head -n 1 || true)"
            if [ -z "$WHEEL" ]; then
              echo "No .whl found in deploy_art. Listing:"
              find deploy_art -maxdepth 4 -type f -print || true
              exit 1
            fi

            echo "Using wheel: $WHEEL"

            REL="/opt/restoringvalues/releases/${BUILD_NUMBER}"

            SSH_OPTS="-i $SSH_KEY_FILE -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

            echo "==> Create release dir on server"
            ssh $SSH_OPTS ${SSH_USER}@${TARGET_HOST} "mkdir -p ${REL}"

            echo "==> Upload wheel"
            scp $SSH_OPTS "$WHEEL" ${SSH_USER}@${TARGET_HOST}:"${REL}/"

            echo "==> Point /opt/restoringvalues/current to this release"
            ssh $SSH_OPTS ${SSH_USER}@${TARGET_HOST} "ln -sfn ${REL} /opt/restoringvalues/current"

            echo "==> Install/update + systemd restart"
            ssh $SSH_OPTS ${SSH_USER}@${TARGET_HOST} 'bash -s' <<'REMOTE'
              set -euo pipefail

              # базовая подготовка (можно оставить, даже если уже делал)
              sudo apt-get update -y >/dev/null 2>&1 || true
              sudo apt-get install -y python3-venv psmisc >/dev/null 2>&1 || true

              sudo mkdir -p /opt/restoringvalues/{releases,bin,run}
              sudo chown -R ubuntu:ubuntu /opt/restoringvalues

              cd /opt/restoringvalues/current
              WHEEL="$(ls -1 *.whl | head -n 1)"

              if [ ! -d /opt/restoringvalues/venv ]; then
                python3 -m venv /opt/restoringvalues/venv
              fi

              . /opt/restoringvalues/venv/bin/activate
              python -m pip install -U pip
              python -m pip install --force-reinstall "$WHEEL"

              cat >/opt/restoringvalues/bin/start.sh <<'SH'
#!/usr/bin/env bash
set -euo pipefail
cd /opt/restoringvalues/current

# чистим порты
for p in 8092 8093 8094 8095; do
  fuser -k ${p}/tcp >/dev/null 2>&1 || true
done

mkdir -p /opt/restoringvalues/run
rm -f /opt/restoringvalues/run/*.pid /opt/restoringvalues/run/*.log || true

start_bg() {
  local name="$1"; shift
  setsid nohup "$@" > "/opt/restoringvalues/run/${name}.log" 2>&1 & echo $! > "/opt/restoringvalues/run/${name}.pid"
}

start_bg simulator python3 Simulator/simulator.py
sleep 1
start_bg reciever  python3 Reciever/reciever.py
start_bg business  python3 Business/business.py

# держим unit живым
wait
SH
              chmod +x /opt/restoringvalues/bin/start.sh

              cat >/opt/restoringvalues/bin/stop.sh <<'SH'
#!/usr/bin/env bash
set -euo pipefail

stop_by_pidfile() {
  local f="$1"
  if [ -f "$f" ]; then
    pid="$(cat "$f")"
    kill -- "-$pid" >/dev/null 2>&1 || true
  fi
}

stop_by_pidfile /opt/restoringvalues/run/business.pid
stop_by_pidfile /opt/restoringvalues/run/reciever.pid
stop_by_pidfile /opt/restoringvalues/run/simulator.pid

for p in 8092 8093 8094 8095; do
  fuser -k ${p}/tcp >/dev/null 2>&1 || true
done
SH
              chmod +x /opt/restoringvalues/bin/stop.sh

              sudo tee /etc/systemd/system/restoringvalues.service >/dev/null <<'UNIT'
[Unit]
Description=RestoringValues stack (simulator/reciever/business)
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/restoringvalues/current
ExecStart=/opt/restoringvalues/bin/start.sh
ExecStop=/opt/restoringvalues/bin/stop.sh
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
UNIT

              sudo systemctl daemon-reload
              sudo systemctl enable restoringvalues.service >/dev/null 2>&1 || true
              sudo systemctl restart restoringvalues.service

              echo "==> service status"
              sudo systemctl --no-pager --full status restoringvalues.service || true
REMOTE
          '''
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'deploy_art/**', allowEmptyArchive: true
      cleanWs()
    }
  }
}
