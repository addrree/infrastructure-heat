pipeline {
  agent { label 'tool' }

  options {
    timestamps()
    timeout(time: 20, unit: 'MINUTES')
  }

  parameters {
    choice(name: 'DASH_MODE', choices: ['prod', 'test'], description: 'prod => 8051, test => 8050')
  }

  environment {
    VM_IP = '192.168.199.173'
    APP_DIR = '/opt/restoringvalues'
    SSH_USER = 'ubuntu'
    SSH_CRED = 'Andrey-heatvm'   // <-- ID credential с cloudkey.pem
    ARTIFACT_JOB = 'AndreyLAb2'    // <-- job, который собирает artifact-restoringvalues.tgz
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Get artifact from Build job') {
      steps {
        copyArtifacts projectName: "${env.ARTIFACT_JOB}",
          selector: lastSuccessful(),
          filter: 'artifact-restoringvalues.tgz',
          fingerprintArtifacts: true
        sh 'ls -la artifact-restoringvalues.tgz'
      }
    }

    stage('Deploy to VM + systemd (with Dash)') {
      steps {
        withCredentials([sshUserPrivateKey(credentialsId: "${env.SSH_CRED}", keyFileVariable: 'SSH_KEY')]) {
          sh '''#!/usr/bin/env bash
set -euo pipefail

DASH_MODE="${DASH_MODE:-prod}"
if [ "$DASH_MODE" = "prod" ]; then
  DASH_FILE="GUI/dash_app_prod.py"
  DASH_PORT="8051"
else
  DASH_FILE="GUI/dash_app_test.py"
  DASH_PORT="8050"
fi

echo "==> Deploy artifact-restoringvalues.tgz to ${SSH_USER}@${VM_IP}:${APP_DIR} (dash=$DASH_MODE)"

# 1) копируем артефакт
scp -i "$SSH_KEY" -o StrictHostKeyChecking=no artifact-restoringvalues.tgz ${SSH_USER}@${VM_IP}:/tmp/artifact-restoringvalues.tgz

# 2) всё остальное делаем на VM
ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no ${SSH_USER}@${VM_IP} bash -s -- "$DASH_FILE" "$DASH_PORT" <<'EOS'
set -euo pipefail
DASH_FILE="$1"
DASH_PORT="$2"
APP_DIR="/opt/restoringvalues"

echo "==> Prepare dirs"
sudo mkdir -p "$APP_DIR"
sudo chown -R ubuntu:ubuntu "$APP_DIR"

echo "==> Unpack artifact"
cd "$APP_DIR"
rm -rf Simulator Reciever Business GUI requirements.txt *.log || true
tar -xzf /tmp/artifact-restoringvalues.tgz
rm -f /tmp/artifact-restoringvalues.tgz

echo "==> Install runtime deps"
sudo apt-get update -y
sudo apt-get install -y python3-venv python3-pip

echo "==> Create venv"
python3 -m venv .venv
. .venv/bin/activate
pip install -U pip wheel
pip install -r requirements.txt

echo "==> Create systemd unit"
SERVICE_FILE="/etc/systemd/system/restoringvalues.service"
sudo tee "$SERVICE_FILE" >/dev/null <<UNIT
[Unit]
Description=RestoringValues demo (Simulator + Reciever + Business + Dash)
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/restoringvalues
Environment=WEBSOCKET_HOST=127.0.0.1
ExecStart=/bin/bash -lc '
set -e
cd /opt/restoringvalues
. .venv/bin/activate

# чистим старые файлы
rm -f Reciever/*.csv Business/*.csv Business/data_out_*.csv Business/data_metrics_*.csv || true

# стартуем процессы
nohup python3 Simulator/simulator.py > simulator.log 2>&1 &
nohup python3 Reciever/reciever.py  > reciever.log 2>&1 &
nohup python3 Business/business.py  > business.log 2>&1 &
exec python3 '"$DASH_FILE"' --host 0.0.0.0 --port '"$DASH_PORT"' > dash.log 2>&1
'
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
UNIT

echo "==> Restart service"
sudo systemctl daemon-reload
sudo systemctl enable restoringvalues.service
sudo systemctl restart restoringvalues.service

echo "==> Status"
sudo systemctl --no-pager -l status restoringvalues.service || true

echo "==> Listening ports (should include 8092-8095 and ${DASH_PORT})"
ss -lntp | egrep ":8092|:8093|:8094|:8095|:${DASH_PORT}" || true

echo "==> Dash URL: http://$(hostname -I | awk '{print $1}'):${DASH_PORT}"
EOS
'''
        }
      }
    }
  }

  post {
    always {
      echo "Done."
      cleanWs()
    }
  }
}
