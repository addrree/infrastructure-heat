// Jenkinsfile-deploy
// LAB4: забираем артефакт из job сборки (LAB2) и деплоим на VM 192.168.199.173 по SSH
pipeline {
  agent { label 'tool' }

  options {
    timestamps()
    timeout(time: 15, unit: 'MINUTES')
  }

  parameters {
    string(name: 'BUILD_JOB', defaultValue: 'AndreyLAb2', description: 'Имя job из ЛАБ2, где архивируется artifact-restoringvalues.tgz')
    string(name: 'BUILD_NUMBER', defaultValue: 'lastSuccessfulBuild', description: 'Номер сборки (можно lastSuccessfulBuild)')
    string(name: 'VM_IP', defaultValue: '192.168.199.173', description: 'IP VM для деплоя')
    string(name: 'SSH_CRED_ID', defaultValue: 'ubuntu-agent-ssh', description: 'Jenkins CredentialsId типа "SSH Username with private key"')
    string(name: 'DEPLOY_DIR', defaultValue: '/opt/restoringvalues', description: 'Куда деплоить на VM')
  }

  environment {
    ARTIFACT = 'artifact-restoringvalues.tgz'
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Get artifact from Build job') {
      steps {
        // NB: Copy Artifact plugin должен быть установлен (у тебя он уже работает)
        copyArtifacts(
          projectName: params.BUILD_JOB,
          selector: (params.BUILD_NUMBER == 'lastSuccessfulBuild'
                    ? lastSuccessful()
                    : specific(params.BUILD_NUMBER)),
          filter: "${env.ARTIFACT}",
          fingerprintArtifacts: true
        )

        sh '''#!/usr/bin/env bash
          set -euo pipefail
          ls -la "${ARTIFACT}"
        '''
      }
    }

    stage('Deploy to VM (systemd)') {
      steps {
        withCredentials([sshUserPrivateKey(
          credentialsId: params.SSH_CRED_ID,
          keyFileVariable: 'SSH_KEY',
          usernameVariable: 'SSH_USER'
        )]) {
          sh '''#!/usr/bin/env bash
            set -euo pipefail

            VM_IP="${VM_IP}"
            DEPLOY_DIR="${DEPLOY_DIR}"
            ARTIFACT="${ARTIFACT}"

            echo "==> Deploy ${ARTIFACT} to ${SSH_USER}@${VM_IP}:${DEPLOY_DIR}"

            # 1) подготовка папки на VM
            ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" "${SSH_USER}@${VM_IP}" "sudo mkdir -p '${DEPLOY_DIR}' && sudo chown ${SSH_USER}:${SSH_USER} '${DEPLOY_DIR}'"

            # 2) загрузка артефакта
            scp -o StrictHostKeyChecking=no -i "$SSH_KEY" "${ARTIFACT}" "${SSH_USER}@${VM_IP}:${DEPLOY_DIR}/"

            # 3) распаковка + venv + зависимости + systemd unit + рестарт
            ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" "${SSH_USER}@${VM_IP}" "bash -lc '
              set -euo pipefail
              cd \"${DEPLOY_DIR}\"

              echo \"==> Unpack\"
              tar -xzf \"${ARTIFACT}\"

              echo \"==> Ensure python3-venv\"
              sudo apt-get update -y
              sudo apt-get install -y python3-venv python3-pip

              echo \"==> Create venv + install deps\"
              rm -rf .venv
              python3 -m venv .venv
              . .venv/bin/activate
              pip install -U pip wheel
              pip install -r requirements.txt

              echo \"==> Write systemd unit\"
              sudo tee /etc/systemd/system/restoringvalues.service >/dev/null <<EOF
[Unit]
Description=RestoringValues services (sim+recv+business)
After=network.target

[Service]
Type=simple
User=${SSH_USER}
WorkingDirectory=${DEPLOY_DIR}
Environment=WEBSOCKET_HOST=127.0.0.1

# Запускаем 3 процесса, GUI не трогаем
ExecStart=/bin/bash -lc \"
  set -e
  ${DEPLOY_DIR}/.venv/bin/python3 Simulator/simulator.py  > simulator.log 2>&1 &
  ${DEPLOY_DIR}/.venv/bin/python3 Reciever/reciever.py    > reciever.log  2>&1 &
  ${DEPLOY_DIR}/.venv/bin/python3 Business/business.py    > business.log  2>&1 &
  wait
\"

Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

              echo \"==> Restart service\"
              sudo systemctl daemon-reload
              sudo systemctl enable restoringvalues
              sudo systemctl restart restoringvalues

              echo \"==> Status (last lines)\"
              sudo systemctl --no-pager --full status restoringvalues | tail -n 60
            '"

            echo "==> Deploy OK"
          '''
        }
      }
    }
  }

  post {
    always {
      echo "Done."
      cleanWs()
    }
  }
}
